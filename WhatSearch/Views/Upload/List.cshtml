@using WhatSearch.Controllers
@using WhatSearch.Utility
@{
    this.Layout = "_Layout.cshtml";
}

@section header {
    <style>
        progress {
            width: 100%;
            height: 2em;
            color: black;
            font-size: 1.5em;
            text-align: center;
            padding-top:2px;
            font-weight:bold;
        }
        progress:before {
            content: attr(data-label);            
        }
    </style>
}



<body>
    <div class="container-fluid" id="app" v-cloak>
        <h1>上傳(最大200MB)</h1>
        <div>
            <input v-on:change="startUploadFile" id="picFile" type="file" ref="picFile" class="form-control-file" accept="*/*" style="padding:10px; font-size:2em" />
        </div>
        <div>
            <progress :value="progress" :data-label="progressText"></progress>
        </div>
        <h1>列表(保存3天)</h1>
        <table class="table">
            @foreach (WhatSearch.Controllers.UploadController.FileDownloadInfoModel fi in ViewBag.Items)
            {
                <tr>
                    <td style="font-size:1.5em"><a href="/upload/file/@fi.Id">@fi.Title</a></td>
                    <td>@fi.Size</td>
                    <td>@fi.Time</td>
                    <td>@fi.DeleteAfter</td>
                </tr>
            }
        </table>
    </div>

    <script type="text/javascript">
        window.app = new Vue({
            el: '#app',
            watch: {
                chunks(n, o) {
                    if (n.length > 0) {
                        this.upload();
                    }
                }
            },
            data: {
                file: null,
                uploaded: 0,
                chunks: []
            },
            computed: {
                progress() {
                    if (this.file == null) {
                        return '';
                    }
                    return this.uploaded / this.file.size;
                },
                progressText() {
                    if (this.file == null) {
                        return '';
                    }
                    var val = Math.ceil(this.uploaded * 100 / this.file.size);
                    if (val >= 100) {
                        return val.toString() + '% 完成';
                    } else {
                        return val.toString() + '%';
                    }
                    
                }
            },
            methods: {
                reset() {
                    this.file = null;
                    this.uploaded = 0;
                    this.chunks = [];
                    document.getElementById('picFile').value = '';
                },

                createChunks() {
                    let size = 512*1024, chunks = Math.ceil(this.file.size / size);
                    this.uploaded = 0;
                    for (let i = 0; i < chunks; i++) {
                        this.chunks.push(this.file.slice(
                            i * size, Math.min(i * size + size, this.file.size), this.file.type
                        ));
                    }
                },

                startUploadFile() {
                    let files = this.$refs.picFile.files;
                    if (files.length > 0) {
                        this.file = files[0];
                        this.createChunks();                        
                    }
                },


                upload: function () {

                    const self = this;

                    let config = {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    }
                    
                    let fd = new FormData;

                    fd.set('file_name', this.file.name);
                    fd.set('is_start', this.uploaded == 0 ? 'true' : 'false');
                    fd.set('is_end', this.chunks.length == 1 ? 'true' : 'false');
                    fd.set('file', this.chunks[0]);
                    
                    this.uploaded += this.chunks[0].size;

                    axios.post('/upload/post', fd, config).then(res => {
                        self.chunks.shift();
                        if (self.chunks.length == 0) {
                            window.setTimeout(function () {
                                location.reload();
                            }, 1000);
                        }
                    }).catch(err => {
                        console.log(err.response);
                        alert(err.response.data);
                        self.reset();
                    }).then(res => {
                    });

                   
                }

            },
            beforeCreate: function () {

            },
            mounted: function () {

            }
        });


    </script>
</body>