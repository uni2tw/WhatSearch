@using WhatSearch.Core
@using WhatSearch.Controllers
@using WhatSearch.Utility


<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>設定帳號與密碼</title>
  <!-- 引入Bootstrap CSS -->
  <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />  
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.1.2/axios.min.js"></script>
</head>
<body>
  <div id="app" class="container">
    <div class="row">
      <div class="col-md-4 offset-md-4 mt-5">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">設定帳號與密碼</h3>
          </div>
          <div class="card-body">
            <form @@submit.prevent="submitForm()" method="post">
              <div class="mb-3">
                <label for="email" class="form-label">電子郵件地址</label>
                <input type="email" class="form-control" id="email" v-model="email" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">新密碼</label>
                <input type="password" class="form-control" id="password" required v-model="password">
              </div>
              <div class="mb-3">
                <label for="confirm-password" class="form-label">確認密碼</label>
                <input type="password" class="form-control" id="confirm-password" required v-model="confirmPassword">
              </div>
              <button type="submit" class="btn btn-primary">重設密碼</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    function setCookie(name, value, days) {
      let expires = '';
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        expires = '; expires=' + date.toUTCString();
      }
      document.cookie = name + '=' + value + expires + '; path=/';
    }

    // 使用示例：将令牌存储到名为 authToken 的 Cookie 中，有效期为 30 天
    //const token = 'your_auth_token';
    //setCookie('authToken', token, 30);

    </script>

  <!-- 引入Bootstrap JavaScript -->  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
    <script type="text/javascript">
    const App = {
        data() {
            return {
                email: "",
                password: "",
                confirmPassword: "",
                emailError: false,
                passwordError: false,
                confirmPasswordError: false,
            };
        },
        methods: {
            submitForm() {
                this.emailError = !this.validateEmail(this.email);
                this.passwordError = !this.validatePassword(this.password);
                this.confirmPasswordError = !this.validateConfirmPassword(
                    this.password,
                    this.confirmPassword
                );
                if (
                    !this.emailError &&
                    !this.passwordError &&
                    !this.confirmPasswordError
                ) {
                    // Your form submission logic goes here.
                    console.log("Form submitted successfully!");                    
                    var formData = new FormData();
                    formData.append('username', this.email);
                    formData.append('password', this.password);
                    axios({
                      method: "post",
                      url: "/user/confirm_reset_password",
                      data: formData,
                      headers: { "Content-Type": "multipart/form-data" },
                    })
                    .then(function (response) {
                        //handle success
                        console.log(response);
                    })
                    .catch(function (response) {
                        //handle error
                        console.log(response);
                    });       
                } else {
                    alert('請確認輸入email格式的帳號，密碼要>=6位數，且密碼與確認密碼要一致')
                    return false;
                }
            },
            validateEmail(email) {
                var validRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
                if (email.match(validRegex)) {                                
                    return true;
                } else {             
                    return false;
                }
            },
            validatePassword(password) {
                return password.length >= 6;
            },
            validateConfirmPassword(password, confirmPassword) {
                return password === confirmPassword;
            },
        },
    };
    
    const vm = Vue.createApp(App);
    vm.mount('#app');
    </script>
  </body>
  </html>